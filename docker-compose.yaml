version: '3'
services:
  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:3.7.14-management
    ports:
    - 15672:15672
    networks:
      - pipeline_net

  business_controller:
    container_name: business_controller
    image: business_controller:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
      - BUSINESS_QUEUE=business_queue
      - BUSINESS_EXCHANGE=business_exchange
      - BUSINESS_MESSAGE_SIZE=1025
      - EXCHANGE_INCOMING_BUSINESS=exchange_incoming_business
    networks:
      - pipeline_net

  review_controller:
    container_name: review_controller
    image: review_controller:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
      - REVIEWS_QUEUE=reviews_queue
      - WEEKDAY_QUEUE=weekday_queue
      - WEEKDAY_AGGREGATORS_QUANTITY=2
      - REVIEWS_MESSAGE_SIZE=10000
      - EXCHANGE_INCOMING_REVIEWS=exchange_incoming_reviews
      - FUNNY_REVIEWS_QUEUE=funny_reviews_queue
      - FUNNY_REVIEWS_JOINERS_QUANTITY=1
      - USER_ID_QUEUE=user_id_queue
      - USER_ID_AGGREGATORS_QUANTITY=2
      - FIVE_STARS_USER_ID_QUEUE=five_stars_user_id_queue
      - FIVE_STARS_USER_ID_AGGREGATORS_QUANTITY=2
      - TEXT_HASH_QUEUE=text_hash_queue
      - TEXT_HASH_AGGREGATORS_QUANTITY=2
    networks:
      - pipeline_net

  aggregator_hash_1:
    container_name: aggregator_hash_1
    image: multikeyaggregator:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
      - SOURCE_QUEUE=text_hash_queue
      - REDUCER_QUEUE=text_hash_reducer_queue
      - PRINCIPAL_KEY=user_id
      - SECONDARY_KEY=text_hash
    networks:
      - pipeline_net

  aggregator_hash_2:
    container_name: aggregator_hash_2
    image: multikeyaggregator:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
      - SOURCE_QUEUE=text_hash_queue
      - REDUCER_QUEUE=text_hash_reducer_queue
      - PRINCIPAL_KEY=user_id
      - SECONDARY_KEY=text_hash
    networks:
      - pipeline_net

  reducer_hash:
    container_name: reducer_hash
    image: multikeyreducer:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
      - AGGREGATORS_QUANTITY=2
      - AGGREGATED_DATA_QUEUE=text_hash_reducer_queue
      - SINK_QUEUE=users_same_text_filter_queue
      - UNFLATTEN_KEY=user_id
      - UNFLATTEN_VALUE_KEY=hashes
    networks:
      - pipeline_net

  filter_same_text:
    container_name: filter_same_text
    image: filter:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
      - DATA_QUEUE=users_same_text_filter_queue
      - SINK_EXCHANGE=user_same_text_exchange
      - FILTER_OPERATION=multi_key_special_filter
      - FILTER_PARAMETER=5
    networks:
      - pipeline_net

networks:
  pipeline_net:
    ipam:
      driver: default
      config:
        - subnet: 172.25.128.0/24